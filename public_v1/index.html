<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Additive Manufacturing Roadmap</title>
  <style>
    /* GLOBAL STYLES */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f7f7f7;
      text-align: center;
    }
    h1, h2, h3 { color: #333; }
    .nav-buttons {
      margin-bottom: 20px;
      text-align: center;
    }
    .nav-buttons button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      background-color: #00269A;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin: 20px auto;
      max-width: 1000px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: left;
      display: none;
    }
    .section.active { display: block; }
    .back-button {
      margin-top: 20px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background-color: #00269A;
      color: white;
      border: none;
      border-radius: 4px;
    }
    /* Tile container: left-justify tiles */
    .tile-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    .tile {
      background: #e8e8e8;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      width: 80%;
      cursor: pointer;
      text-align: left;
    }
    table.roadmap {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      table-layout: fixed;
    }
    table.roadmap th, table.roadmap td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
      font-size: 12px;
      word-wrap: break-word;
    }
    table.roadmap th:first-child, table.roadmap td:first-child { min-width: 120px; }
    table.roadmap th { background: #eee; }
    .roadmap-task { color: #fff; font-weight: bold; }
    .milestone-cell {
      background: #000;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }
    /* Status Colors */
    .status-complete { background: #4CAF50; }
    .status-funded-division { background: #2196F3; }
    .status-funded-sector { background: #FF9800; }
    .status-funded-crad { background: #9C27B0; }
    .status-planned { background: #9E9E9E; }
  </style>
</head>
<body>
  <h1>Additive Manufacturing Roadmap</h1>
  <div class="nav-buttons">
    <button id="browseProductBtn">Browse by Product Class</button>
    <button id="browseMaterialBtn">Browse by Material System</button>
    <button id="browseCradBtn">Browse CRAD Opportunities</button>
    <button id="browseSupplierBtn">Browse by Supplier</button>
  </div>

  <!-- PAGE SECTIONS -->
  <div id="landingSection" class="section active">
    <h2>Welcome</h2>
    <p>Please select an option above.</p>
    <button class="back-button" onclick="goBack()">Back</button>
  </div>

  <!-- Products List Section -->
  <div id="productSection" class="section">
    <h2>Products Under Development</h2>
    <div id="productsListContainer" class="tile-container">
      <!-- Product tiles will be rendered here -->
    </div>
    <button class="back-button" onclick="goBack()">Back</button>
  </div>

  <!-- Product Details Section -->
  <div id="productDetailsSection" class="section">
    <h2 id="prodTitle">[Product Title Placeholder]</h2>
    <p id="prodDrivingCharacteristics">[Driving Characteristics Placeholder]</p>
    <div id="prodDivisions" style="font-weight: bold; color: #00269A;">[Divisions Placeholder]</div>
    <!-- Material Systems Lane -->
    <div>
      <h3>Material Systems</h3>
      <div id="tileMaterialSystems" class="tile-container">
        <!-- Material system tiles -->
      </div>
    </div>
    <!-- Supply Chain Lane -->
    <div>
      <h3>Supply Chain</h3>
      <div id="tileSupplyChain" class="tile-container">
        <!-- Supplier tiles -->
      </div>
    </div>
    <!-- Applicable CRAD Opportunities for this Product -->
    <div>
      <h3>Applicable CRAD Opportunities</h3>
      <div id="tileProductCrad" class="tile-container">
        <!-- Product CRAD tiles -->
      </div>
    </div>
    <!-- Product Roadmap Section -->
    <div id="productRoadmapSection">
      <h3>Product Roadmap</h3>
      <div id="productRoadmapContainer">
        <p>[Product Roadmap Placeholder]</p>
      </div>
    </div>
    <button class="back-button" onclick="goBack()">Back</button>
  </div>

  <!-- Material List Section -->
  <div id="materialListSection" class="section">
    <h2>Select a Material System</h2>
    <div id="materialTilesContainer" class="tile-container">
      <!-- Material system tiles will be rendered here -->
    </div>
    <button class="back-button" onclick="goBack()">Back</button>
  </div>

  <!-- Material Details Section -->
  <div id="materialDetailSection" class="section">
    <h2 id="matTitle">[Material Title Placeholder]</h2>
    <div id="matDivisions" style="font-weight: bold; color: #00269A;">[Divisions Placeholder]</div>
    <p id="matDescription"><strong>Material:</strong> [Description Placeholder]</p>
    <p id="matPrintingProcess"><strong>Printing Process:</strong> [Printing Process Placeholder]</p>
    <div>
      <h3>CRAD Programs</h3>
      <div id="tileMaterialCrad" class="tile-container">
        <!-- Material CRAD tiles -->
      </div>
    </div>
    <div>
      <label for="startYearInput"><strong>Timeline Start Year:</strong></label>
      <input type="number" id="startYearInput" value="2025">
      <button id="updateRoadmapBtn">Update Roadmap</button>
    </div>
    <div id="roadmapContainer">
      <p>[Material Roadmap Placeholder]</p>
    </div>
    <div id="roadmapKey">
      <p><strong>Roadmap Key:</strong>
        <span class="status-complete" style="padding:2px 6px; border-radius:3px;">Complete</span>,
        <span class="status-funded-division" style="padding:2px 6px; border-radius:3px;">Funded (Division IRAD)</span>,
        <span class="status-funded-sector" style="padding:2px 6px; border-radius:3px;">Funded (Sector IRAD)</span>,
        <span class="status-funded-crad" style="padding:2px 6px; border-radius:3px;">Funded (CRAD)</span>,
        <span class="status-planned" style="padding:2px 6px; border-radius:3px;">Planned</span>
      </p>
    </div>
    <button class="back-button" onclick="goBack()">Back</button>
  </div>

  <!-- CRAD Opportunities Section -->
  <div id="cradOpportunitiesSection" class="section">
    <h2>CRAD Opportunities</h2>
    <div id="cradOpportunitiesTable">
      <p>[CRAD Opportunities Table Placeholder]</p>
    </div>
    <button class="back-button" onclick="goBack()">Back</button>
  </div>

  <!-- CRAD Opportunity Details Section -->
  <div id="cradOpportunityDetailSection" class="section">
    <h2 id="cradTitle">[CRAD Title Placeholder]</h2>
    <div id="cradDetailContent">
      <p>[CRAD Opportunity Details Placeholder]</p>
    </div>
    <button class="back-button" onclick="goBack()">Back</button>
  </div>

  <!-- Suppliers Section -->
  <div id="suppliersSection" class="section">
    <h2>Suppliers</h2>
    <div id="suppliersTilesContainer" class="tile-container">
      <!-- Supplier tiles will be rendered here -->
    </div>
    <button class="back-button" onclick="goBack()">Back</button>
  </div>

  <!-- Supplier Details Section -->
  <div id="supplierDetailSection" class="section">
    <h2 id="supplierName">[Supplier Name Placeholder]</h2>
    <div id="supplierDetailContent">
      <p>[Supplier Details Placeholder]</p>
    </div>
    <div id="supplierRoadmapContainer">
      <p>[Supplier Roadmap Placeholder]</p>
    </div>
    <button class="back-button" onclick="goBack()">Back</button>
  </div>

  <!-- Roadmap Task Detail Section -->
  <div id="roadmapItemDetailSection" class="section">
    <h2>Task Details</h2>
    <div id="roadmapItemDetailsContent">
      <p>[Task Details Placeholder]</p>
    </div>
    <button class="back-button" onclick="goBack()">Back</button>
  </div>

  <!-- Milestone Detail Section -->
  <div id="milestoneDetailSection" class="section">
    <h2 id="milestoneTitle">[Milestone Title Placeholder]</h2>
    <p id="milestoneDescription">[Milestone Description Placeholder]</p>
    <p><strong>Completion Date:</strong> <span id="milestoneDate">N/A</span></p>
    <p><strong>Funding Details:</strong> <span id="milestoneFunding">N/A</span></p>
    <p><strong>Notes:</strong> <span id="milestoneNotes">N/A</span></p>
    <div id="milestoneTasks">
      <p>[Associated Tasks Placeholder]</p>
    </div>
    <button class="back-button" onclick="goBack()">Back</button>
  </div>

  <!-- COMMON FUNCTIONS & INITIALIZATION -->
  <script>
    // Navigation functions
    let navStack = [];
    let currentSection = "landingSection";
    function showSection(id) {
      if (currentSection && currentSection !== id) { navStack.push(currentSection); }
      document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      currentSection = id;
    }
    function goBack() {
      if (navStack.length > 0) { const prev = navStack.pop(); showSection(prev); }
      else { showSection("landingSection"); }
    }
    window.showSection = showSection;
    window.goBack = goBack;

    document.addEventListener("DOMContentLoaded", function() {

      // Expose data access functions globally
      window.getProducts = function() {
        let prods = localStorage.getItem("amProducts");
        if (!prods) { localStorage.setItem("amProducts", JSON.stringify([])); prods = "[]"; }
        return JSON.parse(prods);
      };
      window.getMaterials = function() {
        let mats = localStorage.getItem("amMaterials");
        if (!mats) { localStorage.setItem("amMaterials", JSON.stringify([])); mats = "[]"; }
        return JSON.parse(mats);
      };
      window.getCradOpportunities = function() {
        let opps = localStorage.getItem("amCradOpportunities");
        if (!opps) { localStorage.setItem("amCradOpportunities", JSON.stringify([])); opps = "[]"; }
        return JSON.parse(opps);
      };
      window.getSuppliers = function() {
        let sups = localStorage.getItem("amSuppliers");
        if (!sups) { localStorage.setItem("amSuppliers", JSON.stringify([])); sups = "[]"; }
        return JSON.parse(sups);
      };

      // Data access setters
      function setProducts(prods) { localStorage.setItem("amProducts", JSON.stringify(prods)); }
      function setMaterials(mats) { localStorage.setItem("amMaterials", JSON.stringify(mats)); }
      function setCradOpportunities(opps) { localStorage.setItem("amCradOpportunities", JSON.stringify(opps)); }
      function setSuppliers(sups) { localStorage.setItem("amSuppliers", JSON.stringify(sups)); }

      // Common functions: dateToQuarterIndex and assignRows
      function dateToQuarterIndex(dateStr, baseYear) {
        if (!dateStr) { console.error("Missing date string"); return 0; }
        const parts = dateStr.split("-");
        if (parts.length < 3) { console.error("Invalid date format: " + dateStr); return 0; }
        const year = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        const quarter = Math.floor((month - 1) / 3) + 1;
        return (year - baseYear) * 4 + (quarter - 1);
      }
      function assignRows(tasks) {
        tasks.sort((a, b) => a.startIndex - b.startIndex);
        const rows = [];
        tasks.forEach(task => {
          let placed = false;
          for (const row of rows) {
            const last = row[row.length - 1];
            if (last.endIndex < task.startIndex) { row.push(task); placed = true; break; }
          }
          if (!placed) { rows.push([task]); }
        });
        return rows;
      }

      /* ---------- PRODUCT SECTION ---------- */
      function loadProductsList() {
        const products = getProducts();
        const container = document.getElementById("productsListContainer");
        container.innerHTML = "";
        if (!products.length) { container.innerHTML = "<p>No products available.</p>"; return; }
        // Render products as vertical tiles (left justified)
        products.forEach(product => {
          const tile = document.createElement("div");
          tile.className = "tile";
          tile.textContent = product.title;
          tile.addEventListener("click", function() {
            loadProductDetails(product);
            showSection("productDetailsSection");
          });
          container.appendChild(tile);
        });
      }
      function loadProductDetails(product) {
        document.getElementById("prodTitle").textContent = product.title || "N/A";
        document.getElementById("prodDrivingCharacteristics").textContent = product.drivingCharacteristics || "N/A";
        document.getElementById("prodDivisions").textContent = "Divisions: " + (product.divisions && product.divisions.length ? product.divisions.join(", ") : "N/A");
        // Render Material Systems tiles
        const tileMS = document.getElementById("tileMaterialSystems");
        tileMS.innerHTML = "";
        const materials = getMaterials();
        product.materialSystems.forEach(msID => {
          const material = materials.find(m => m.id === msID);
          if (material) {
            const tile = document.createElement("div");
            tile.className = "tile";
            tile.innerHTML = `<strong>${material.name}</strong>`;
            tile.addEventListener("click", function() {
              loadMaterialDetails(material);
              showSection("materialDetailSection");
            });
            tileMS.appendChild(tile);
          }
        });
        // Render Supply Chain tiles
        renderProductSupplyChainTiles(product);
        // Render Applicable CRAD Opportunities for this Product
        renderProductCradTiles(product);
        // Render Product Roadmap using new fields:
        renderProductRoadmap(product);
      }
      function renderProductSupplyChainTiles(product) {
        const materials = getMaterials();
        const suppliers = getSuppliers();
        const productMaterialIds = product.materialSystems;
        const container = document.getElementById("tileSupplyChain");
        container.innerHTML = "";
        const filteredSuppliers = suppliers.filter(sup => sup.materials.some(mID => productMaterialIds.includes(mID)));
        if (!filteredSuppliers.length) { container.innerHTML = "<p>No suppliers available.</p>"; return; }
        filteredSuppliers.forEach(sup => {
          const suppliedMaterials = sup.materials.filter(mID => productMaterialIds.includes(mID))
            .map(mID => {
              const mat = materials.find(m => m.id === mID);
              return mat ? mat.name : mID;
            });
          const tile = document.createElement("div");
          tile.className = "tile";
          tile.innerHTML = `<strong>${sup.name}</strong><br><small>${suppliedMaterials.join(", ")}</small>`;
          tile.onclick = function() { loadSupplierDetails(sup.id); };
          container.appendChild(tile);
        });
      }
      // New function: Render Applicable CRAD Opportunities for a product
      function renderProductCradTiles(product) {
        const opps = getCradOpportunities();
        const today = new Date();
        const applicable = opps.filter(o => {
          return o.applicableProducts && o.applicableProducts.includes(product.title) &&
                 new Date(o.rfpCloseDate) >= today;
        });
        const container = document.getElementById("tileProductCrad");
        container.innerHTML = "";
        if (!applicable.length) {
          container.innerHTML = "<p>No applicable CRAD opportunities.</p>";
          return;
        }
        applicable.forEach(o => {
          const tile = document.createElement("div");
          tile.className = "tile";
          tile.innerHTML = `<strong>${o.programName}</strong><br><small>${o.department || "N/A"}</small>`;
          tile.onclick = function() { loadCradOpportunityDetails(o.id); };
          container.appendChild(tile);
        });
      }
      // Updated renderProductRoadmap using new fields:
      function renderProductRoadmap(product) {
        const totalYears = 5;
        const totalQuarters = totalYears * 4;
        const baseYear = 2025;
        // Lane 1: Material Systems tasks
        let lane1Tasks = [];
        const materials = getMaterials();
        product.materialSystems.forEach(msID => {
          const material = materials.find(m => m.id === msID);
          if (material && material.roadmap) {
            material.roadmap.forEach(task => {
              lane1Tasks.push({ ...task, task: material.name + ": " + task.task });
            });
          }
        });
        // Lane 2: Supply Chain tasks
        let lane2Tasks = [];
        const suppliers = getSuppliers();
        const productMaterialIds = product.materialSystems;
        suppliers.forEach(sup => {
          if (sup.materials.some(mID => productMaterialIds.includes(mID)) && sup.supplierRoadmap) {
            sup.supplierRoadmap.tasks.forEach(task => {
              lane2Tasks.push({ ...task, task: sup.name + ": " + task.task });
            });
          }
        });
        // Lane 3: Design Tools & References tasks (from product.digitalToolsReferences)
        let lane3Tasks = [];
        if (product.digitalToolsReferences) {
          product.digitalToolsReferences.forEach(task => { 
            // Use task.name if available, otherwise fallback to task.task
            lane3Tasks.push({ ...task, task: task.name || task.task, category: "Design Tools & References" }); 
          });
        }
        // Lane 4: Part Acceptance tasks (from product.partAcceptanceRoadmap)
        let lane4Tasks = [];
        if (product.partAcceptanceRoadmap) {
          product.partAcceptanceRoadmap.forEach(task => { 
            lane4Tasks.push({ ...task, task: task.name || task.task, category: "Part Acceptance" }); 
          });
        }
        const colorMap = {
          "complete": "#4CAF50",
          "funded (division irad)": "#2196F3",
          "funded (sector irad)": "#FF9800",
          "funded (crad)": "#9C27B0",
          "planned": "#9E9E9E"
        };
        function processLane(tasks) {
          return tasks.map(task => {
            const sIndex = dateToQuarterIndex(task.start, baseYear);
            const eIndex = dateToQuarterIndex(task.end, baseYear);
            return {
              ...task,
              startIndex: Math.max(0, sIndex),
              endIndex: Math.min(totalQuarters - 1, eIndex),
              color: colorMap[task.status.toLowerCase()] || "#00269A"
            };
          });
        }
        const lanes = [
          { title: "Material Systems", tasks: processLane(lane1Tasks) },
          { title: "Supply Chain", tasks: processLane(lane2Tasks) },
          { title: "Design Tools & References", tasks: processLane(lane3Tasks) },
          { title: "Part Acceptance", tasks: processLane(lane4Tasks) }
        ];
        let html = "<table class='roadmap'>";
        // Header row: Years
        html += "<tr><th></th>";
        for (let i = 0; i < totalYears; i++) {
          html += `<th colspan="4">${baseYear + i}</th>`;
        }
        html += "</tr>";
        // Quarter row
        html += "<tr><th></th>";
        for (let i = 0; i < totalYears; i++) {
          for (let q = 1; q <= 4; q++) {
            html += `<th>Q${q}</th>`;
          }
        }
        html += "</tr>";
        // Milestone row at the top (for material roadmap)
        const material = materials.find(m => m.name === document.getElementById("matTitle").textContent.replace(" Details", ""));
        const processedMilestones = (material && material.milestones ? material.milestones : [])
          .map(ms => ({ ...ms, index: Math.max(0, Math.min(totalQuarters - 1, dateToQuarterIndex(ms.date, baseYear))) }));
        html += "<tr>";
        html += "<td>Milestones</td>";
        let pointer = 0;
        processedMilestones.sort((a, b) => a.index - b.index).forEach(ms => {
          if (ms.index > pointer) { html += `<td colspan="${ms.index - pointer}"></td>`; }
          html += `<td colspan="1" class="milestone-cell" title="${ms.name}" onclick='showMilestoneDetail("${encodeURIComponent(JSON.stringify(ms))}")'>${ms.name}</td>`;
          pointer = ms.index + 1;
        });
        if (pointer < totalQuarters) { html += `<td colspan="${totalQuarters - pointer}"></td>`; }
        html += "</tr>";
        // Render each swimlane
        lanes.forEach(lane => {
          const rows = assignRows(lane.tasks);
          if (rows.length === 0) {
            html += `<tr><td>${lane.title}</td><td colspan="${totalQuarters}">No tasks.</td></tr>`;
          } else {
            for (let i = 0; i < rows.length; i++) {
              const row = rows[i];
              html += "<tr>";
              if (i === 0) { html += `<td rowspan="${rows.length}">${lane.title}</td>`; }
              let pointer = 0;
              row.sort((a, b) => a.startIndex - b.startIndex).forEach(task => {
                if (task.startIndex > pointer) { html += `<td colspan="${task.startIndex - pointer}"></td>`; }
                const colspan = task.endIndex - task.startIndex + 1;
                html += `<td colspan="${colspan}" class="roadmap-task" style="background-color: ${task.color}; cursor: pointer;" title="${task.task}" data-task='${encodeURIComponent(JSON.stringify(task))}' onclick="showRoadmapItemDetail(event)">${task.task}</td>`;
                pointer = task.endIndex + 1;
              });
              if (pointer < totalQuarters) { html += `<td colspan="${totalQuarters - pointer}"></td>`; }
              html += "</tr>";
            }
          }
        });
        html += "</table>";
        document.getElementById("productRoadmapContainer").innerHTML = html;
      }
      // New function: renderSupplierRoadmap
      function renderSupplierRoadmap(supplier) {
        if (!supplier.supplierRoadmap) {
          document.getElementById("supplierRoadmapContainer").innerHTML = "<p>No roadmap available.</p>";
          return;
        }
        const totalYears = 5;
        const totalQuarters = totalYears * 4;
        const baseYear = 2025;
        const colorMap = {
          "complete": "#4CAF50",
          "funded (division irad)": "#2196F3",
          "funded (sector irad)": "#FF9800",
          "funded (crad)": "#9C27B0",
          "planned": "#9E9E9E"
        };
        // For suppliers, assume two swimlanes: "Material System Vendor Qual" and "Supplier Management"
        let lane1Tasks = [];
        let lane2Tasks = [];
        supplier.supplierRoadmap.tasks.forEach(task => {
          if (task.category === "Material System Vendor Qual") {
            lane1Tasks.push(task);
          } else {
            lane2Tasks.push(task);
          }
        });
        function processLane(tasks) {
          return tasks.map(task => {
            const sIndex = dateToQuarterIndex(task.start, baseYear);
            const eIndex = dateToQuarterIndex(task.end, baseYear);
            return {
              ...task,
              startIndex: Math.max(0, sIndex),
              endIndex: Math.min(totalQuarters - 1, eIndex),
              color: colorMap[task.status.toLowerCase()] || "#00269A"
            };
          });
        }
        const lanes = [
          { title: "Material System Vendor Qual", tasks: processLane(lane1Tasks) },
          { title: "Supplier Management", tasks: processLane(lane2Tasks) }
        ];
        let html = "<table class='roadmap'>";
        html += "<tr><th></th>";
        for (let i = 0; i < totalYears; i++) {
          html += `<th colspan="4">${baseYear + i}</th>`;
        }
        html += "</tr><tr><th></th>";
        for (let i = 0; i < totalYears; i++) {
          for (let q = 1; q <= 4; q++) {
            html += `<th>Q${q}</th>`;
          }
        }
        html += "</tr>";
        // For simplicity, no milestone row here
        lanes.forEach(lane => {
          const rows = assignRows(lane.tasks);
          if (rows.length === 0) {
            html += `<tr><td>${lane.title}</td><td colspan="${totalQuarters}">No tasks.</td></tr>`;
          } else {
            for (let i = 0; i < rows.length; i++) {
              const row = rows[i];
              html += "<tr>";
              if (i === 0) { html += `<td rowspan="${rows.length}">${lane.title}</td>`; }
              let pointer = 0;
              row.sort((a, b) => a.startIndex - b.startIndex).forEach(task => {
                if (task.startIndex > pointer) { html += `<td colspan="${task.startIndex - pointer}"></td>`; }
                const colspan = task.endIndex - task.startIndex + 1;
                html += `<td colspan="${colspan}" class="roadmap-task" style="background-color: ${task.color}; cursor: pointer;" title="${task.task}" data-task='${encodeURIComponent(JSON.stringify(task))}' onclick="showRoadmapItemDetail(event)">${task.task}</td>`;
                pointer = task.endIndex + 1;
              });
              if (pointer < totalQuarters) { html += `<td colspan="${totalQuarters - pointer}"></td>`; }
              html += "</tr>";
            }
          }
        });
        html += "</table>";
        document.getElementById("supplierRoadmapContainer").innerHTML = html;
      }
      // Modify loadSupplierDetails to call renderSupplierRoadmap
      window.loadSupplierDetails = function(id) {
        const suppliers = getSuppliers();
        const sup = suppliers.find(s => s.id === id);
        if (!sup) return;
        document.getElementById("supplierName").textContent = sup.name || "N/A";
        let html = `<p><strong>Additional Capabilities:</strong> ${sup.additionalCapabilities || "N/A"}</p>`;
        html += `<p><strong>Supplier Notes:</strong> ${sup.supplierNotes || "N/A"}</p>`;
        const materials = getMaterials();
        const materialNames = sup.materials.map(mID => {
          const m = materials.find(mat => mat.id === mID);
          return m ? m.name : mID;
        });
        html += `<p><strong>Materials Supplied:</strong> ${materialNames.length ? materialNames.join(", ") : "N/A"}</p>`;
        const machineMapping = { 1: "Arcam EBM A2", 2: "EOS M290", 3: "Optomec LENS" };
        const machineNames = sup.machines.map(mID => machineMapping[mID] || mID);
        html += `<p><strong>Machines Supplied:</strong> ${machineNames.length ? machineNames.join(", ") : "N/A"}</p>`;
        document.getElementById("supplierDetailContent").innerHTML = html;
        renderSupplierRoadmap(sup);
        showSection("supplierDetailSection");
      };
      window.showMilestoneDetail = function(encodedMilestone) {
        const ms = JSON.parse(decodeURIComponent(encodedMilestone));
        document.getElementById("milestoneTitle").textContent = ms.name || "N/A";
        document.getElementById("milestoneDescription").textContent = ms.description || "N/A";
        document.getElementById("milestoneDate").textContent = ms.date || "N/A";
        document.getElementById("milestoneFunding").textContent = ms.fundingDetails || "N/A";
        document.getElementById("milestoneNotes").textContent = ms.notes || "N/A";
        document.getElementById("milestoneTasks").innerHTML = "";
        showSection("milestoneDetailSection");
      };
      window.showRoadmapItemDetail = function(event) {
        const td = event.currentTarget;
        const taskData = td.getAttribute("data-task");
        const task = JSON.parse(decodeURIComponent(taskData));
        let detailsHTML = `
          <p><strong>Task:</strong> ${task.task || "N/A"}</p>
          <p><strong>Category:</strong> ${task.category || "N/A"}</p>
          <p><strong>Start:</strong> ${task.start || "N/A"}</p>
          <p><strong>End:</strong> ${task.end || "N/A"}</p>
          <p><strong>Status:</strong> ${task.status || "N/A"}</p>
        `;
        if (task.fundingDetails && task.fundingDetails.trim() !== "") {
          detailsHTML += `<p><strong>Funding Details:</strong> ${task.fundingDetails}</p>`;
        }
        if (task.details && task.details.trim() !== "") {
          detailsHTML += `<p><strong>Details:</strong> ${task.details}</p>`;
        }
        document.getElementById("roadmapItemDetailsContent").innerHTML = detailsHTML;
        showSection("roadmapItemDetailSection");
      };
      window.loadCradOpportunityDetails = function(id) {
        const opps = getCradOpportunities();
        const opp = opps.find(o => o.id === id);
        if (!opp) return;
        document.getElementById("cradTitle").textContent = opp.programName || "N/A";
        let html = `<p><strong>Department/Agency:</strong> ${opp.department || "N/A"}</p>`;
        html += `<p><strong>Expected Funding:</strong> ${opp.expectedFunding || "N/A"}</p>`;
        html += `<p><strong>Period of Performance:</strong> ${opp.periodOfPerformance || "N/A"}</p>`;
        html += `<p><strong>Applicable Products:</strong> ${(opp.applicableProducts && opp.applicableProducts.length) ? opp.applicableProducts.join(", ") : "N/A"}</p>`;
        html += `<p><strong>Applicable Material Systems:</strong> ${(opp.applicableMaterials && opp.applicableMaterials.length) ? opp.applicableMaterials.join(", ") : "N/A"}</p>`;
        html += `<p><strong>RFP Close Date:</strong> ${opp.rfpCloseDate || "N/A"}</p>`;
        html += `<p><strong>Contract Type:</strong> ${opp.contractType || "N/A"}</p>`;
        html += `<p><strong>Required Cost Share %:</strong> ${opp.costSharePercentage || "N/A"}</p>`;
        html += `<p><strong>RFP Link:</strong> <a href="${opp.rfpLink || "#"}" target="_blank">${opp.rfpLink || "N/A"}</a></p>`;
        html += `<p><strong>Notes:</strong> ${opp.notes || "N/A"}</p>`;
        document.getElementById("cradDetailContent").innerHTML = html;
        showSection("cradOpportunityDetailSection");
      };

      /* ---------- INITIAL NAVIGATION SETUP ---------- */
      document.getElementById("browseProductBtn").addEventListener("click", function() {
        loadProductsList();
        showSection("productSection");
      });
      document.getElementById("browseMaterialBtn").addEventListener("click", function() {
        renderMaterialTiles();
        showSection("materialListSection");
      });
      document.getElementById("browseCradBtn").addEventListener("click", function() {
        renderCradOpportunitiesTable();
        showSection("cradOpportunitiesSection");
      });
      document.getElementById("browseSupplierBtn").addEventListener("click", function() {
        renderSuppliersTiles();
        showSection("suppliersSection");
      });
      showSection("landingSection");

      // Render material tiles as groups by category (left justified)
      function renderMaterialTiles() {
        const materials = getMaterials();
        const container = document.getElementById("materialTilesContainer");
        container.innerHTML = "";
        const groups = {};
        materials.forEach(mat => {
          const cat = mat.category || "Other";
          groups[cat] = groups[cat] || [];
          groups[cat].push(mat);
        });
        for (const cat in groups) {
          const groupDiv = document.createElement("div");
          groupDiv.innerHTML = `<h3>${cat}</h3>`;
          groups[cat].forEach(mat => {
            const tile = document.createElement("div");
            tile.className = "tile";
            tile.textContent = mat.name;
            tile.addEventListener("click", function() {
              loadMaterialDetails(mat);
              showSection("materialDetailSection");
            });
            groupDiv.appendChild(tile);
          });
          container.appendChild(groupDiv);
        }
      }
    });
  </script>
  <!-- END COMMON FUNCTIONS & INITIALIZATION -->
</body>
</html>
